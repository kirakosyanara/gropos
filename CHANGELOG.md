# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

## [Unreleased] - 2026-01-03

### Added
- **PosBranchSettings Repository** - Phase 4 Start (System Configuration)
  - Created `BranchSetting` and `BranchSettings` domain models with typed accessors
  - Created `LegacyBranchSettingDto` for legacy mapping
  - Implemented `CouchbaseBranchSettingsRepository` for Desktop and Android
  - Features: in-memory caching with Mutex for thread safety
  - Common settings: `CashPaymentLimit`, `LotteryPayoutTier1/2`, `ReturnLimitWithoutApproval`
  - Wired in both `DatabaseModule.kt` files
  - Updated BACKEND_INTEGRATION_STATUS.md: 13 of 15 collections Connected

- **Android Platform Parity** - Part B Complete
  - Ported `CouchbaseTaxRepository` to Android
  - Ported `CouchbaseCrvRepository` to Android
  - Ported `CouchbaseCustomerGroupRepository` to Android
  - Ported `CouchbaseConditionalSaleRepository` to Android
  - Ported `CouchbaseVendorPayoutRepository` to Android
  - Updated Android `DatabaseModule.kt` with all repository bindings
  - Full feature parity between Desktop and Android platforms

- **ConditionalSale Repository** - Phase 3C Implementation
  - Created `ConditionalSale` domain model with `ConditionalSaleType` enum
  - Created `LegacyConditionalSaleDto` for legacy mapping
  - Implemented `CouchbaseConditionalSaleRepository` for Desktop and Android
  - Methods: `getActiveRules()`, `getRulesForProduct()`, `getAgeRestrictionRules()`, `getRequiredAgeForProduct()`
  - Dynamic age verification rules from database (replaces hardcoded logic)

- **VendorPayout Repository** - Phase 3C Implementation
  - Created `VendorPayout` domain model with `VendorPayoutType` enum
  - Created `LegacyVendorPayoutDto` with bidirectional mapping
  - Implemented `CouchbaseVendorPayoutRepository` for Desktop and Android
  - Methods: `savePayout()`, `getPayoutsForDateRange()`, `getTodayPayoutTotal()`, `getUnsyncedPayouts()`
  - Full sync support with `markAsSynced()` method

- **CustomerGroup Repository** - Phase 3A Implementation
  - Created `CustomerGroup`, `CustomerGroupDepartment`, `CustomerGroupItem` domain models
  - Created `LegacyCustomerGroupDto`, `LegacyCustomerGroupDepartmentDto`, `LegacyCustomerGroupItemDto` for legacy mapping
  - Implemented `CouchbaseCustomerGroupRepository` for Desktop (reads from legacy `pos` scope)
  - Repository interface with: `getActiveGroups()`, `getGroupById()`, `getGroupByName()`, 
    `getDepartmentDiscounts()`, `getDepartmentDiscount()`, `getItemDiscounts()`, `getItemDiscount()`, `hasGroupPricing()`
  - Wired in `DatabaseModule.kt` (Desktop) with interface binding
  - Updated BACKEND_INTEGRATION_STATUS.md: CustomerGroup collections now ‚úÖ Connected

- **Tax and CRV Repositories** - Phase 3B Implementation
  - Created `Tax` and `Crv` domain models with calculation methods
  - Created `LegacyTaxDto` and `LegacyCrvDto` for legacy mapping
  - Implemented `CouchbaseTaxRepository` for Desktop (reads from legacy `pos` scope)
    - Methods: `getAllTaxes()`, `getTaxById()`, `getTaxByName()`, `getTaxesByIds()`
  - Implemented `CouchbaseCrvRepository` for Desktop (reads from legacy `pos` scope)
    - Methods: `getAllCrvRates()`, `getCrvById()`, `getDefaultSmallContainerCrv()`, `getDefaultLargeContainerCrv()`
  - Wired in `DatabaseModule.kt` (Desktop) with interface bindings
  - Updated BACKEND_INTEGRATION_STATUS.md: Tax and CRV collections now ‚úÖ Connected

- **Backend Integration Status Document** (`docs/data/BACKEND_INTEGRATION_STATUS.md`)
  - Comprehensive gap analysis between legacy Couchbase schema and new domain models
  - Connection Matrix: 8 collections fully/partially connected, 8 missing implementations
  - Field Mapping Reference: 27 fields requiring rename mappings, 15 fields missing
  - Missing Data Report: Critical fields (brand, unitSize, qtyLimitPerCustomer)
  - Implementation Priorities: Phased approach for migration (4 weeks)
  - Technical Recommendations: DTO strategy, pending document pattern

- **Legacy Product DTO** (`LegacyProductDto.kt`)
  - Maps legacy Couchbase Product JSON to domain model
  - Handles field renames: name‚ÜíproductName, categoryId‚Üícategory, foodStampable‚ÜíisSnapEligible
  - Transforms: statusId (enum)‚ÜíisActive (boolean), ageRestrictionId‚ÜíageRestriction (Int)
  - Includes `fromMap()` parser and `toDomain()` mapper

- **Legacy Transaction DTO** (`LegacyTransactionDto.kt`)
  - Maps legacy LocalTransaction JSON to domain Transaction
  - Field mappings: employee‚ÜíemployeeName, startDate‚ÜístartDateTime, savingsTotal‚ÜídiscountTotal
  - Includes item and payment DTOs with bidirectional mapping

- **CouchbaseTransactionRepository** (Desktop)
  - Full implementation of TransactionRepository using CouchbaseLite
  - **Pending Document Pattern**: Active transactions saved as `{guid}-P`, finalized on completion
  - Resume crashed transactions on startup via `-P` suffix detection
  - Supports Hold/Recall, Search, and Pullback operations
  - Uses legacy `pos` scope for backend compatibility

### Changed
- **Product Domain Model** (`Product.kt`)
  - Added missing legacy fields: brand, unitSize, qtyLimitPerCustomer, receiptName
  - Added: returnPolicyId, primaryImageUrl, createdDate, updatedDate
  - Added computed properties: displayNameForReceipt, hasQuantityLimit

- **CouchbaseProductRepository** (Desktop & Android)
  - Now uses LegacyProductDto for proper field mapping
  - Reads from legacy `pos` scope (where backend syncs data)
  - Writes using legacy field names for backend compatibility
  - Supports both legacy and new document formats


- **Documentation Audit (January 3, 2026)** - Full codebase verification
  - Updated PHASE_4_STATUS_REPORT.md: Progress 80% ‚Üí 100% Complete
  - Updated PHASE_4_GAP_ANALYSIS.md: All success criteria checked
  - Updated REMEDIATION_CHECKLIST.md: Added Lottery Module section (13 items)
  - Verified 327 test cases (73 lottery-specific)
  - Confirmed all Phase 4 & 5 items implemented

## [1.0.0-beta] - 2026-01-02

### Added
- **Phase 4: Desktop Scale Driver - COMPLETE**
  - **CasProtocolParser** (commonMain) - CAS PD-II protocol frame parser
    - 18-byte ASCII frame parsing
    - Stable/Unstable detection (ST/US flags)
    - Overweight/Underweight detection (OL flag)
    - Unit support (lb, kg, oz)
    - Full TDD test suite (20 test cases)
  - **DesktopCasScale** (desktopMain) - ScaleService implementation
    - jSerialComm serial communication
    - Continuous weight streaming
    - Cable disconnect detection
    - Tare/Zero command support
    - Auto-detect scale port
  - **HardwareModule** - Added ScaleService registration
    - Production: DesktopCasScale
    - Development: SimulatedScaleService
    - ScaleConfig from environment variables

- **Phase 5: Lottery Module - Presentation Layer - COMPLETE**
  - **LotterySaleScreen** (Step 14) - Lottery Sales UI
    - Grid layout for lottery game cards
    - Category filtering (All, Scratchers, Draw Games)
    - Cart summary with quantity +/- controls
    - Total calculation with BigDecimal precision
    - Checkout flow with sale recording
    - Navigation from FunctionsPanel "Lotto Pay" button
    - LotterySaleViewModel with TDD test coverage
  - **LotteryPayoutScreen** (Step 15) - Lottery Payout UI
    - Numeric keypad for amount entry
    - Real-time payout validation via PayoutTierCalculator
    - PayoutTierBadge component (Approved/LoggedOnly/Rejected)
    - Manager approval dialog for Tier 2 payouts
    - LotteryPayoutViewModel with TDD test coverage
  - **LotteryReportScreen** (Step 16) - Lottery Reports UI
    - Daily summary display (Sales/Payouts/Net)
    - Date navigation controls
    - Scratcher vs Draw game breakdown
    - LotteryReportViewModel with repository integration
  - **LotteryModule** - Added all ViewModels to DI
    - LotterySaleViewModel, LotteryPayoutViewModel, LotteryReportViewModel

### Changed
- **Documentation Sync (Post-Implementation Verification)**
  - **PHASE_4_STATUS_REPORT.md** - Updated to reflect actual codebase state
    - Fixed Step 9: OfflineQueue and SyncWorker marked as ‚úÖ IMPLEMENTED (were incorrectly ‚ùå)
    - Fixed Steps 10-12: Remote repositories (Till, Vendor, Device) marked as ‚úÖ IMPLEMENTED
    - Fixed Step 13: Lottery Domain Layer marked as ‚úÖ COMPLETE (9 items)
    - Updated summary: 59/74 items complete (~80% vs previous 68%)
    - Updated Hardware tables: Scanner/Printer drivers now ‚úÖ for Desktop and Android
    - Updated Blocking Issues: Most critical issues now resolved
  - **PHASE_4_GAP_ANALYSIS.md** - Corrected false claims
    - Fixed Scale driver: `DesktopCasScale` marked as ‚ö†Ô∏è PENDING (was incorrectly ‚úÖ)
    - Added Step 9 and Step 13 completion checkboxes
    - Updated Lottery section: Domain layer complete, presentation pending
    - Updated timeline: Remaining work ~1-2 weeks
  - **REMEDIATION_CHECKLIST.md** - Fixed hardware status
    - Fixed CAS Scale: Changed from ‚úÖ Match to ‚ö†Ô∏è Partial
    - Added Android Hardware and Desktop Hardware sections to summary

### Added
- **Phase 5: Lottery Module - Domain Layer**
  - **Domain Models (LotteryModels.kt)**
    - `LotteryGame` - Game catalog (scratchers + draw games)
    - `LotteryGameType` enum (SCRATCHER, DRAW)
    - `LotteryTransaction` - Sale/payout records
    - `LotteryTransactionType` enum (SALE, PAYOUT)
    - `PayoutStatus` enum with tier labels
    - `PayoutValidationResult` for UI display
    - `LotteryDailySummary` for reports
  - **PayoutTierCalculator** - Business logic for payout tiers
    - Tier 1: $0-$49.99 ‚Üí APPROVED
    - Tier 2: $50-$599.99 ‚Üí LOGGED_ONLY
    - Tier 3: $600+ ‚Üí REJECTED_OVER_LIMIT (W-2G deferred)
    - BigDecimal precision with HALF_UP rounding
    - Full TDD test suite (23 test cases)
  - **LotteryRepository Interface**
    - `getActiveGames()` - Flow of active games
    - `recordSale()` - Record ticket purchases
    - `checkPayoutFeasibility()` - Validate payout amount
    - `processPayout()` - Process with tier enforcement
    - `getCurrentDaySummary()` - Daily totals
  - **FakeLotteryRepository**
    - 10 seeded games (5 scratchers + 5 draw)
    - In-memory transaction storage
    - Full test coverage (19 test cases)
  - **LotteryModule (Koin DI)**
    - Wired into AppModule
    - Provides FakeLotteryRepository

- **Phase 4.6: API Completeness & Remote Repositories**
  - **ApiClient** - Central HTTP client with Ktor
    - Bearer token injection via tokenProvider
    - Automatic 401 handling with onUnauthorized callback
    - Error mapping to ApiException sealed class
    - Configurable timeouts (30s default)
  - **RemoteTillRepository** - REST API for till operations
    - GET /till - Fetch all tills
    - POST /till/{id}/assign - Assign to employee
    - POST /till/{id}/release - Release assignment
    - TillDto + TillDomainMapper
    - Full TDD test suite
  - **RemoteVendorRepository** - REST API for vendor lookup
    - GET /vendor - Fetch vendors
    - In-memory cache for session
    - VendorDto + VendorDomainMapper
    - Graceful degradation on network errors
  - **RemoteDeviceRepository** - REST API for device registration
    - POST /device-registration/qr-registration
    - GET /device-registration/device-status/{guid}
    - SecureStorage integration for credentials
    - DeviceDto + DeviceDomainMapper
    - PlatformInfo interface for device naming
  - **SecureStorage Interface** - Secure credential storage
    - saveStationId/getStationId
    - saveApiKey/getApiKey
    - saveBranchInfo/getBranchInfo
    - InMemorySecureStorage for testing
  - **CameraPreview Composable** - Android camera viewfinder
    - CameraX PreviewView integration
    - Scanning overlay with target box
    - Permission handling UI
    - Close button
  - **CameraScannerDialog** - Modal scanner for checkout
    - Single-scan mode (auto-dismiss)
    - InlineCameraScanner for embedded use

- **Android Hardware Drivers (Phase 4 - Production Hardware)**
  - **SunmiPrinterService** - Native Sunmi POS thermal printer
    - AIDL service binding to IWoyouService
    - Reflection-based method invocation for SDK compatibility
    - Receipt formatting (header, items, totals, barcode, footer)
    - Paper status monitoring (OK, Low, Empty)
    - Cash drawer support via printer service
    - Failed print job queue with retry
  - **CameraBarcodeScanner** - CameraX + MLKit barcode scanner
    - Support for UPC-A, UPC-E, EAN-13, EAN-8, CODE-128, CODE-39, QR
    - 500ms debounce to prevent duplicate scans
    - Lifecycle-aware camera binding
    - Background thread image analysis
    - PreviewView integration for UI display
  - **SunmiHardwareScanner** - Native Sunmi hardware scanner
    - BroadcastReceiver for `com.sunmi.scanner.ACTION_DATA_CODE_RECEIVED`
    - Works with built-in laser scanners (V2 Pro, T2, etc.)
    - 300ms debounce for rapid scans
  - **Android HardwareModule** - Koin DI wiring
    - Auto-detection: SUNMI, PAX, GENERIC device types
    - Build-variant switching (release uses real hardware)
    - SafeScannerRepository wrapper
    - SimulatedPrinterService fallback
  - **Dependencies Added (libs.versions.toml)**
    - Sunmi Printer SDK: `com.sunmi:printerlibrary:1.0.19`
    - CameraX: `androidx.camera:camera-*:1.3.0`
    - MLKit Barcode: `com.google.android.gms:play-services-mlkit-barcode-scanning:18.3.0`

- **Desktop Hardware Drivers (Phase 4 - Production Hardware)**
  - **DesktopSerialScanner** - Real serial barcode scanner via jSerialComm
    - Auto-discovery of available COM/serial ports
    - Configurable baud rate (default 9600)
    - Buffer-based protocol parsing (CR/LF terminator detection)
    - Overflow protection (128 char limit)
    - Thread-safe SharedFlow emission
    - Port enumeration API for settings UI
  - **DesktopEscPosPrinter** - Real ESC/POS thermal printer via jSerialComm
    - Full ESC/POS command protocol implementation
    - Receipt formatting with item lines, totals, barcode
    - Cash drawer support (pulse command via RJ-11)
    - Paper status monitoring
    - Failed print job queue with retry support
    - Auto-reconnection on disconnect
  - **HardwareModule** - Koin DI wiring for desktop hardware
    - Environment variable configuration (SCANNER_PORT, PRINTER_PORT)
    - Runtime switch: USE_REAL_HARDWARE=true/false
    - SafeScannerRepository wrapper for production
    - SimulatedPrinterService fallback for development

### Fixed
- **PaymentViewModelTest Coroutine Errors (CRITICAL)**
  - Fixed `UncompletedCoroutinesError` in 2 previously @Ignored tests
  - Root cause: ViewModel's `observeCartChanges()` launches infinite Flow
  - Solution: `@BeforeTest` sets `Dispatchers.Main` to `StandardTestDispatcher`
  - Solution: `@AfterTest` cancels `viewModelScope` and calls `resetMain()`
  - All 17 PaymentViewModelTest cases now pass green

- **Network & Auth Hardening (QA Audit Fix - CRITICAL)**
  - **TokenRefreshManager Race Condition Fix**
    - Replaced unsafe `isRefreshing` boolean with `Mutex` and `CompletableDeferred`
    - Concurrent 401 handlers now share single refresh result (no duplicate API calls)
    - 12 unit tests verifying concurrent behavior
    - Per QA finding: Multiple 401s were triggering multiple refresh attempts
  
  - **OfflineQueue Implementation**
    - `DefaultOfflineQueueService` - Thread-safe queue with Mutex
    - FIFO processing order for fairness
    - Retry count tracking per item
    - `AbandonedItem` list for items exceeding max retries
    - `QueueItemSyncHandler` interface for API integration
    - `ProcessResult` sealed class (Success, Retry, Abandon)
    - 15 unit tests covering queue operations
  
  - **SyncWorker with Exponential Backoff**
    - `SyncWorker` - Background sync orchestrator
    - Exponential backoff: `baseDelay * 2^failures + jitter`
    - Jitter factor prevents "thundering herd" on reconnection
    - `SyncWorkerState` observable for UI binding
    - `resetBackoff()` for external network state triggers
    - 9 unit tests covering backoff behavior

- **PaymentViewModel Test Coverage (QA Audit Fix - CRITICAL)**
  - **PaymentViewModelTest** - 17 test cases for payment processing
    - Cash payment: exact change, overpayment with change
    - Split tender: cash + card, two/three payment combinations
    - Card payments: approved, declined, error, cancelled
    - Terminal dialog visibility during processing
    - Transaction save failure handling
    - TenKey input: digit, clear, backspace
    - EBT SNAP payment flow
    - 2 tests marked @Ignore pending coroutine investigation

- **Hardware Safety Layer (QA Audit Fix - CRITICAL)**
  - **BarcodeInputValidator** - Scanner input sanitization and validation
    - `sanitize()` - Strips control characters (0x00-0x1F)
    - `isValidLength()` - Rejects < 3 or > 128 characters
    - `shouldRateLimit()` - Blocks scans within 50ms (prevents flooding)
    - `validate()` - Full pipeline returning `ValidationResult` sealed class
    - 34 unit tests covering attack vectors (buffer overflow, ANSI injection)
  - **SafeScannerRepository** - Decorator for safe scanner operations
    - Wraps any `ScannerRepository` with validation layer
    - Emits `rejectedScans` flow for audit logging
    - 11 integration tests covering edge cases
  - **PrinterService** - Safe hardware abstraction for receipt printers
    - `ConnectionStatus` flow for monitoring connect/disconnect
    - `PrinterEvent` sealed class for proactive alerts
    - `PrintResult` sealed class (never throws exceptions)
    - `FailedPrintJob` queue for mid-print recovery
    - `checkPaperStatus()` for proactive paper monitoring
  - **SimulatedPrinterService** - Test implementation
    - Controllable failure simulation (disconnect, paper out, timeout)
    - Demonstrates safe exception handling pattern
    - 17 unit tests covering all failure modes

- **Phase 4 Status Report** - Comprehensive codebase audit
  - Created `PHASE_4_STATUS_REPORT.md` documenting implementation status
  - Verified 62 items across all Phase 4 steps
  - Hardware Drivers (Step 7): 40% complete - interfaces exist, no real drivers
  - Token Refresh (Step 8): ~75% complete - logic exists, missing HTTP interceptor
  - Offline Queue (Step 9): Interface only - no implementation
  - Remote Repositories (Steps 10-12): 0% - all use Fake implementations
  - Lottery Module (Steps 13-17): 0% - only button placeholder exists
  - Identified blocking issues for production deployment

- **UI Component Polish**
  - **Weight Display Component** - Info Bar integration
    - `WeightDisplayComponent` with stable/motion indicators
    - `ScaleWeightDisplay` auto-wired to ScaleService
    - `CompactWeightDisplay` for smaller spaces
    - `PreviewWeightDisplay` for testing
  - **SNAP Eligible Display** - EBT/SNAP visibility
    - `SnapEligibleDisplay` showing eligible amounts
    - `SnapEligibleBadge` for order cell items
    - `EbtCashEligibleBadge` for EBT cash items
    - `EbtSummaryPanel` for customer display
  - **Navigation Components**
    - `NavigationBackButton` - standard back navigation
    - `BackButtonWithLabel` - labeled back button
    - `CloseButton` - for dialogs/modals
    - `CancelButton` - destructive action styling
    - `NavigationHeader` - title + back button combo
    - `FloatingBackButton` - overlay screens

- **API Authentication System**
  - **ApiAuthService** - Complete authentication service
    - `employeeGroPOSLogin()` with username/password
    - `employeePinLogin()` for PIN-based authentication
    - `refreshToken()` for token refresh
    - `logout()` for session termination
    - `setBearerToken()` for manager override
    - `AuthState` sealed class (Unauthenticated, Authenticating, Authenticated, TokenExpired, Error)
    - `AuthResponse` model for API responses
    - `AuthException` for authentication errors
  - **TokenStorage** - Secure token persistence
    - `TokenStorage` interface for platform implementations
    - `InMemoryTokenStorage` for development
    - `FakeTokenStorage` for testing
    - Methods: saveAccessToken, saveRefreshToken, clearTokens
  - **TokenRefreshManager** - Automatic token refresh
    - `TokenRefreshManager` interface for background refresh
    - `DefaultTokenRefreshManager` with monitoring loop
    - `TokenStatus` sealed class (NoToken, Valid, ExpiringSoon, Expired, Refreshing, RefreshFailed)
    - `TokenRefreshConfig` for configuration
    - `Manager.setBearerToken()` static helper
    - `SimulatedTokenRefreshManager` for testing

- **Sync & Pullback Features**
  - **Pullback Flow** - Recall items from previous transaction
    - `PullbackModels.kt` with `PullbackResult`, `PullbackItem`, `PullbackState`, `PullbackConfig`
    - `PullbackService` interface with `findTransactionForPullback()`, `checkPullbackEligibility()`
    - `DefaultPullbackService` and `SimulatedPullbackService` implementations
    - Transaction repository extensions: `findByGuid()`, `getReturnedQuantities()`, `createPullbackTransaction()`
  - **Heartbeat/Sync Service** - Background data synchronization
    - `HeartbeatService` interface for periodic server connectivity
    - `HeartbeatStatus` model with online status, last sync time, pending items
    - `DefaultHeartbeatService` with heartbeat loop and sync loop
    - `SyncEngine` and `OfflineQueueService` interfaces
    - `SimulatedHeartbeatService` for testing
  - **Approval Audit Collection** - Manager approval tracking
    - `ApprovalAuditService` interface for recording approvals
    - `ApprovalAuditRecord` model with action, manager, employee, values
    - `InMemoryApprovalAuditService` implementation
    - `ApprovalAuditFactory` for common scenarios (price override, discount, void, return, cash pickup)

- **Permission System & Auth Features**
  - **Permission Strings** - Standard format `{App}.{Category}.{Action}`
    - New `PermissionStrings.kt` with structured permission constants
    - Categories: Transactions, Returns, Cash, Lottery, Vendor, Store, Settings
    - Modifiers: `.Request` for approval, `.Self Approval` for managers
    - `PermissionComponents` for parsing permission strings
  - **Permission Checker** - Comprehensive permission checks
    - New `PermissionChecker.kt` with business logic checks
    - `checkLineDiscountPermission()` with threshold integration
    - `checkTransactionDiscountPermission()` with threshold integration
    - `checkPriceOverridePermission()` including floor price checks
    - `checkFloorPriceOverridePermission()` for selling below cost
    - `checkReturnPermission()` with amount thresholds
    - `checkVoidPermission()` with amount thresholds
    - Result types: `DiscountPermissionResult`, `PriceOverridePermissionResult`, etc.
  - **Pre-Assigned Employee Detection**
    - New `PreAssignedEmployeeDetector` interface
    - `DefaultPreAssignedEmployeeDetector` using DeviceService
    - `SimulatedPreAssignedEmployeeDetector` for testing
    - `PreAssignedEmployeeInfo` model with name, job title, image

- **Payment & Settings Features**
  - **PaymentService Singleton** - Centralized payment processing
    - New `PaymentService` interface with card, cash, check, EBT, on-account methods
    - `SimulatedPaymentService` implementation for development/testing
    - `PaymentServiceState` for tracking processing state
    - Methods: `processCashPayment()`, `processCardPayment()`, `processEbtPayment()`, 
      `processCheckPayment()`, `processOnAccountPayment()`, `voidPayment()`, `openCashDrawer()`
  - **On Account Payment** - Customer account charging
    - Validates customer has account charging enabled
    - Checks available credit against account limit
    - Returns approval/decline with appropriate messages
  - **Hardware Settings Screen** - COM port configuration
    - New `HardwareSettingsScreen.kt` with peripheral configuration
    - COM port dropdowns for scanner, printer, scale, cash drawer
    - Payment terminal IP/port configuration
    - Simulated hardware mode toggle
  - **Heartbeat Section** - Sync status display
    - New `HeartbeatSection.kt` with connection indicator
    - Shows last sync time, pending items count
    - Animated connection status indicator
    - Compact `HeartbeatIndicator` for headers

- **Station & Customer Display Features**
  - **Device Info Service** - Station/register identity management
    - New `DeviceInfo` data class with station ID, name, branch info
    - New `HardwareConfig` for COM port settings
    - New `DeviceService` interface with `InMemoryDeviceService` implementation
    - `getStationDisplayName()` and `getFullLocationDisplay()` methods
  - **Station Header Component** - Display station name in UI
    - New `StationHeader.kt` with station name, branch, and employee display
    - New `StationIndicator.kt` for compact station display
  - **Customer Repository** - Loyalty customer lookup
    - New `Customer` model with loyalty points, tier, store credit, account balance
    - New `CustomerRepository` interface for search and selection
    - `FakeCustomerRepository` with seeded customer data
    - Search by name, phone, email, or loyalty card number
  - **Customer Info Bar** - Transaction customer display
    - New `CustomerInfoBar.kt` component with avatar, name, tier badge
    - Shows loyalty points, store credit indicator
    - Search prompt when no customer selected
  - **Customer Search Dialog** - Loyalty card lookup
    - New `CustomerSearchDialog.kt` with search input and results list
    - Displays customer initials avatar, tier, phone, email, points

- **Transaction Search & Audit Features**
  - **Find Transaction Screen** - Full search UI for returns lookup
    - New `FindTransactionScreen.kt` with search bar and results table
    - New `FindTransactionViewModel.kt` with search logic
    - New `FindTransactionUiState.kt` with state models
    - Search by receipt number, date range, amount, employee
  - **Transaction Search API** - `TransactionRepository.searchTransactions()`
    - New `TransactionSearchCriteria` data class for flexible search
    - Implemented in `FakeTransactionRepository` and `CouchbaseTransactionRepository`
    - Supports filtering by receipt number, date range, amount, employee
  - **Approval Audit Service** - Enhanced audit trail logging
    - New `ApprovalAuditService` interface in `core/security/`
    - `InMemoryApprovalAuditService` implementation for development
    - Methods: `logApproval()`, `getRecentApprovals()`, `getApprovalsForEmployee()`, `getApprovalsForAction()`
  - **Permission Thresholds** - Role-based action limits
    - New `PermissionThresholds` data class with configurable limits
    - Presets for CASHIER, SUPERVISOR, MANAGER, ADMIN roles
    - New `ThresholdChecker` object with check methods:
      - `checkLineDiscount()`, `checkTransactionDiscount()`
      - `checkReturn()`, `checkVoid()`, `checkFloorPriceOverride()`
      - `checkCashPickup()`, `checkLotteryPayout()`
    - Returns `ThresholdCheckResult`: Allowed, RequiresApproval, Denied

- **Payment & Permissions Enhancements**
  - **Check Payment** - Full check tender type implementation
    - Added `CheckPayment` and `OnAccountPayment` events to `PaymentEvent`
    - `OtherTabContent` now wires Check button to event handler
    - `PaymentViewModel.onCheckPayment()` processes check payments with full audit logging
    - Check payments follow same pattern as cash (apply, update state, complete transaction)
  - **Self-Approval Logic** - `canSelfApprove()` function for managers
    - Added `PermissionManager.canSelfApprove(user, action)` convenience method
    - Managers with SELF_APPROVAL_ALLOWED or GRANTED can self-approve actions
    - Supports all RequestAction types (CASH_PICKUP, VOID_TRANSACTION, etc.)
  - **Scale/Weight Hardware Interface**
    - New `ScaleService` interface in `core/hardware/scale/`
    - Supports: `connect()`, `disconnect()`, `zero()`, `getWeight()`
    - Reactive flows: `currentWeight`, `status`, `isStable`
    - `SimulatedScaleService` for development/testing with test helpers

- **Customer Display & UI Enhancements**
  - **Voided Item Strikethrough** - Show voided items in red with strikethrough
    - Added `isVoided` property to `CheckoutItemUiModel`
    - `CustomerOrderItem` displays voided items with red color and strikethrough text
    - Voided items included in customer display (previously filtered out)
  - **Savings Display** - "Saved $X.XX" in green for discounted items
    - Added per-line savings display in `CustomerOrderItem`
    - Shows when `hasSavings` is true for non-voided items
  - **Store Name Header** - Already implemented in `CustomerHeader`
    - Displays store name prominently in customer display header
  - **More Information Dialog** - Show full product details popup
    - New `ProductInfoDialog.kt` composable
    - Displays: Name, barcode, prices, department, tax info, CRV, SNAP eligibility, age restriction
    - Accessible from modification mode via "More Info" event
    - `showProductInfoDialog` and `productInfoDialogProduct` states in `CheckoutUiState`

- **Missing Features Implementation (Phase 4 Continuation)**
  - **Price Check Dialog** - Scan item to see price without adding to cart
    - New `PriceCheckDialogState` in `CheckoutUiState`
    - `PriceCheckDialog` composable with TenKey and product display
    - Shows product name, price, and SNAP eligibility
    - Audit logging for accountability
  - **Add Cash Dialog** - Add cash to till drawer (e.g., starting float)
    - New `AddCashDialogState` in `CheckoutUiState`
    - `AddCashDialog` composable with currency input
    - Manager approval required for amounts over $100
    - `CashierSessionManager.addCash()` method for balance updates
  - **Open Drawer Function** - Open cash drawer without transaction
    - `onOpenDrawer()` method in `CheckoutViewModel`
    - Audit logging for all manual drawer opens
  - **Functions Panel Integration** - Full functions panel with tabs
    - `showFunctionsPanel` state for panel visibility
    - Wired all Till tab actions: Open Drawer, Price Check, Add Cash
    - Wired Payment tab actions: Vendor Payout, Cash Pickup
  
  - **Void Payment Support** - Reverse payments before batch settlement
    - Added `processVoid(transactionId, amount)` method to `PaymentTerminal` interface
    - New `VoidResult` sealed class: `Success`, `Declined`, `Error`, `NotFound`
    - `SimulatedPaymentTerminal` tracks approved transactions for voiding
    - Transaction history maintained for audit
  
  - **EBT Balance Check Dialog** - Check customer's EBT balance before payment
    - New `EbtBalanceDialogState` in `CheckoutUiState`
    - `EbtBalanceDialog` composable showing food stamp and cash balances
    - Simulated balance inquiry with processing state
    - Audit logging for all balance inquiries
  
  - **Transaction Discount Dialog** - Apply percentage discount to entire order
    - New `TransactionDiscountDialogState` in `CheckoutUiState`
    - `TransactionDiscountDialog` composable with percentage input and preview
    - Manager approval required for discounts
    - `Cart.applyTransactionDiscount()` applies discount to all items
    - `CartRepository.applyTransactionDiscount()` interface method added
  
  - **QTY Prefix for Multiple Scan** - Enter qty ‚Üí press QTY ‚Üí scan = single line with qty
    - `quantityPrefix` state in `CheckoutUiState`
    - `SetQuantityPrefix` and `ClearQuantityPrefix` events
    - ViewModel methods for quantity prefix handling

### Changed
- **CheckoutContent**: `onFunctionsClick` now opens the full FunctionsPanel dialog
- **CheckoutScreen**: Added event handlers for all new dialog events
- **PaymentTerminal**: Enhanced with `processVoid()` method for void transactions
- **Cart**: Added `applyTransactionDiscount()` for transaction-level discounts
- **CartItem**: Uses `transactionDiscountAmountPerUnit` in tax and subtotal calculations

---

## [0.9.0] - 2026-01-01 - Feature Complete Alpha

**üéâ All P0 Critical Features Complete!**

This release marks the feature-complete alpha milestone for GroPOS. All core POS functionality is implemented and ready for testing.

### P0 Critical Features Summary

1. **Lock Screen & Inactivity Timer (P0 #1)** - Session security with auto-lock after 5 minutes of inactivity
2. **Manager Approval Flow (P0 #2)** - RBAC infrastructure with permission checking and approval dialogs
3. **Checkout Modification Mode (P0 #3)** - Line item editing, quantity changes, and void operations
4. **Employee List + Till Assignment (P0 #4)** - Complete login flow with state machine, employee grid, and till selection
5. **Returns Processing (P0 #5)** - Return item screen with refund calculations and manager approval

---

## [v1.0.0-simulator] - 2026-01-02 - Milestone 1: Simulator Edition

**üöÄ Milestone 1: Simulator Edition - Feature Complete (Local Mode)**

This release represents the complete POS simulator with all P0 (Critical), P2 (Important), and P3 (Nice-to-Have) features implemented for local/offline operation.

### Added
- **Full Error Dialogs - Critical Alert System (P3 #4)**: Flow-stopping error notifications
  - **UI Component (`core/components/dialogs/ErrorDialog.kt`):**
    - Per DIALOGS.md (Error Message Dialog section): Modal dialog for critical errors
    - **Icon:** `Icons.Filled.Error` in danger red color (72dp)
    - **Header:** Red background (#FA1B1B) with bold white title
    - **Body:** Centered message text with proper typography
    - **Button:** Blue primary button ("Dismiss" or custom action label)
    - **Z-Index:** High (1000) to sit above all other content
    - Elevated shadow (24dp) for visual prominence
    - Test tags: `error_dialog`, `error_dialog_icon`, `error_dialog_title`, 
      `error_dialog_message`, `error_dialog_dismiss_button`
  - **State Management (`CheckoutUiState`):**
    - Added `errorDialog: ErrorDialogState? = null` property
    - `ErrorDialogState` data class with title, message, and actionLabel
  - **ViewModel Methods (`CheckoutViewModel`):**
    - `showCriticalError(title, message, actionLabel)`: Shows critical error dialog
    - `dismissError()`: Dismisses the error dialog
  - **Event Wiring (`CheckoutScreen` & `CheckoutContent`):**
    - Added `CheckoutEvent.DismissError` event
    - ErrorDialog rendered when `state.errorDialog != null`
    - `onDismissRequest` properly wired to event handler
  - **Governance Compliance:**
    - **UX Rule:** Only use for errors that STOP THE FLOW:
      - Payment Declined ‚Üí Use `showCriticalError("Payment Declined", reason)`
      - Printer Error ‚Üí Use `showCriticalError("Printer Error", "Out of paper")`
      - Hardware Failure ‚Üí Critical dialog
      - Age Verification Failed (legal) ‚Üí Dialog preferred over Snackbar
    - **Non-Critical Errors:** Product Not Found remains as Snackbar (`ScanEvent.Error`)
    - **Accessibility:** User can always dismiss to return to sales screen
    - **Dismissal:** `dismissOnClickOutside = false` (requires explicit action)

- **NFC Token Login (P3 #2)**: Hardware Abstraction for Badge Authentication
  - **Domain Layer (`features/auth/domain/hardware/`):**
    - `NfcScanner` interface: Hardware abstraction for NFC/RFID badge readers
      - `suspend fun startScan(): NfcResult`: Blocking scan operation
      - `fun cancelScan()`: Cancels in-progress scan
    - `NfcResult` sealed class:
      - `Success(token: String)`: Badge successfully read
      - `Error(message: String)`: Scan failed
      - `Cancelled`: User cancelled scan
  - **Infrastructure Layer (`features/auth/data/`):**
    - `SimulatedNfcScanner`: Development/testing implementation
      - 2-second delay simulating "bringing card to reader"
      - Returns `Success("9999")` (Manager's badge token maps to PIN 9999)
      - Thread-safe with Mutex, supports cancellation
  - **UI Component (`features/auth/presentation/components/ScanBadgeDialog.kt`):**
    - Modal overlay shown during NFC badge scan
    - Animated badge/NFC icon with pulse effect:
      - Dual ring pulse animation (breathing effect)
      - Scale animation for "tap" visual feedback
    - Icon: Badge + Sensors icons combined
    - Text: "Please Tap Employee Badge" / "Hold your badge near the reader"
    - Progress indicator and Cancel button
    - Fallback hint: "or use PIN to sign in"
    - Test tags: `scan_badge_dialog`, `scan_badge_title`, `scan_badge_cancel_button`
  - **LoginContent Updates:**
    - Added "Badge Login" button (Blue, with Badge icon) below Sign In button
    - Button disabled during loading state
    - Test tag: `badge_login_button`
  - **LoginUiState Updates:**
    - Added `isNfcScanActive: Boolean` for dialog visibility state
  - **LoginViewModel Updates:**
    - `onBadgeLoginClick()`: Opens ScanBadgeDialog, starts NFC scan
    - `onCancelNfcScan()`: Cancels scan, closes dialog
    - `handleNfcLoginSuccess()`: Uses badge token as PIN for authentication
    - Non-blocking: Scan runs in coroutine, UI stays responsive
  - **DI Updates (`AuthModule`):**
    - `NfcScanner` interface bound to `SimulatedNfcScanner` (singleton)
    - TODO comment for platform-specific implementations (Sunmi, Android, Desktop)
    - `LoginViewModel` factory updated with `NfcScanner` dependency
  - **Governance Compliance:**
    - **Non-Blocking:** UI remains responsive during scan (coroutines)
    - **Fallback:** Users can always Cancel and use PIN pad
    - Per ANDROID_HARDWARE_GUIDE.md: NFC reader emits token for authentication

- **Advertisement Overlay / Screensaver (P3 #1)**: Idle Screen Digital Signage
  - **UI Component (`features/ad/presentation/AdOverlay.kt`):**
    - Per SCREEN_LAYOUTS.md: "Full-screen ad display when transaction is idle"
    - Full-screen Box with z-index: 100 (renders above all content)
    - Background: Vertical gradient (forest green to emerald) consistent with GroPOS branding
    - Foreground: "Welcome to GroPOS" / "Tap to Start" messaging
    - Animation: Gentle pulsing effect on tap indicator using `rememberInfiniteTransition`
    - Breathing alpha animation on text for subtle motion
    - Promotional banner placeholder: "Fresh Produce Special" (ready for production ad content)
    - Test tags: `ad_overlay`, `ad_overlay_title`, `ad_overlay_tap_indicator`, `ad_overlay_promo_banner`
  - **Logic Wrapper (`core/components/IdleDetector.kt`):**
    - Composable wrapper that tracks user inactivity via `PointerInput`
    - Uses `awaitEachGesture` with `awaitFirstDown(pass = PointerEventPass.Initial)` to intercept all touch events
    - Tracks `lastInteractionTime` using `mutableStateOf` with kotlinx-datetime
    - Uses `LaunchedEffect` to check: `if (now - lastInteraction > timeout) showOverlay = true`
    - State hoisted: `isIdle` and `onIdleChange` callbacks for parent control
    - `onActivity` callback for external timer resets
    - `IdleDetectorConfig` data class with presets:
      - `Testing`: 30 seconds (for easy verification)
      - `Production`: 60 seconds (per requirement)
      - `CustomerDisplay`: 120 seconds
  - **Wiring (`CheckoutContent.kt`):**
    - Entire `CheckoutContent` wrapped inside `IdleDetector`
    - Local `isIdle` state managed with `remember { mutableStateOf(false) }`
    - `AdOverlay` rendered at the end of the Box with z-index priority
    - When AdOverlay is clicked ‚Üí `isIdle = false` ‚Üí Instant dismiss
  - **Governance Compliance:**
    - **Non-Blocking:** Overlay disappears INSTANTLY on touch (no delay)
    - **State Preservation:** Cart/transaction state unchanged when dismissed
      - No state clearing on idle or dismiss
      - All items, quantities, prices preserved exactly
    - **Configuration:** Set to 30 seconds for testing (documented for 60s+ in production)
    - **Theme Consistency:** Uses GroPOS brand colors via `AdOverlayColors` object
  - **Performance:**
    - Single `LaunchedEffect` per IdleDetector instance
    - Effect cancelled and recreated only when `lastInteractionTime` changes
    - Animations use `rememberInfiniteTransition` (no manual coroutine management)
    - Pointer interception at Initial pass (doesn't block child events)

- **Real-time Clock Display (P3 #3)**: Live Time in Status Bar
  - **Component (`core/components/RealTimeClock.kt`):**
    - Per SCREEN_LAYOUTS.md: "Show current time (hh:mm a) in the top right or center"
    - Uses `LaunchedEffect(Unit)` with `while(true)` loop for continuous updates
    - Updates every second via `delay(1000L)`
    - State: `mutableStateOf` for `currentTime` string
    - Format: 12-hour with AM/PM (e.g., "2:30 PM") using `kotlinx-datetime`
    - Automatic cleanup: Compose's lifecycle cancels coroutine on composable exit
    - Test tag: `realtime_clock` for UI automation
  - **UI Integration (`CheckoutContent.kt`):**
    - Clock positioned in header row between GroPOS logo and Logout button
    - Uses `GroPOSColors.TextSecondary` for subtle appearance
    - Typography: `MaterialTheme.typography.bodyLarge` with `FontWeight.SemiBold`
  - **Theme Consistency:**
    - Accepts optional `color` parameter for dark/light theme support
    - Defaults to `GroPOSColors.TextPrimary` (theme-aware)
  - **Performance:**
    - Single coroutine per clock instance (no memory leaks)
    - Only re-composes when time string changes (once per second max)
    - LaunchedEffect cleanup automatic on screen exit

- **Customer Display Ordering Fix (P2 #3)**: UX Polish for Transaction Feed
  - **Visual Sorting (`CheckoutContent.kt`):**
    - Per SCREEN_LAYOUTS.md: "Newest items should appear at the top of the list"
    - Cart items now displayed in REVERSED order (newest first) on Cashier Screen
    - Implementation uses `asReversed()` for efficient view without copying
    - Uses `derivedStateOf` for performance (no new list on every frame)
    - Underlying `Cart` data structure UNCHANGED - only visual presentation affected
  - **Newest Item Highlighting:**
    - Per SCREEN_LAYOUTS.md: "The most recently scanned item should be highlighted"
    - Index 0 (most recent item) receives subtle `ContainerHigh` background
    - Selection highlight (green border) takes priority over newest highlight
    - New `isNewest` parameter added to `OrderListItem` composable
  - **Animation:**
    - Added `animateItem()` modifier to list items for smooth placement transitions
    - Items animate into position when added/removed
  - **Theme Updates (`Color.kt`):**
    - Added `ContainerHigh` color (#E8F5E9) for surface highlighting
  - **Governance Compliance:**
    - Cart data structure remains unchanged (append-only)
    - Only visual presentation is reversed (UI layer responsibility)
    - Performance: Uses `derivedStateOf` instead of creating new list copies
    - Customer Screen unchanged (still uses natural FIFO order per spec)

- **Vendor Payout Screen (P2 #5)**: Cash Drawer Expense Management for paying vendors from till
  - **Domain Layer (`features/cashier/domain/`):**
    - `Vendor` model: id, name for vendor identification
    - `VendorRepository` interface with `getVendors()`, `getVendorById()`
    - `FakeVendorRepository`: Seeded with Coca-Cola, Pepsi, Frito-Lay, Local Bakery
  - **Session Logic (`CashierSessionManager`):**
    - `vendorPayout(amount, vendorId, vendorName, managerId)`: Records payout, decreases cash balance
    - Validation: Cannot pay out more than current drawer balance
    - Validation: Amount must be positive
    - Audit logging: `[AUDIT] VENDOR PAYOUT: $50.00 to Pepsi`
  - **State Management:**
    - Updated `CashierSession` model with vendor payout tracking:
      - `totalVendorPayouts`: Running total of vendor payouts during session
      - `vendorPayoutCount`: Number of payouts performed
    - Updated `ShiftReport` model with vendor payout summary in Z-Report
    - `VendorPayoutDialogState` in `CheckoutUiState`:
      - Two-step flow: VENDOR_SELECTION ‚Üí AMOUNT_INPUT
      - Tracks selected vendor, input amount, current balance, error state
    - `VendorPayoutStep` enum and `VendorUiModel` for UI
  - **UI Component (`VendorPayoutDialog.kt`):**
    - Title: "Vendor Payout" with blue header
    - **Step 1**: Vendor selection grid (2-column layout)
    - **Step 2**: Amount input with TenKey
    - Helper: "Current Drawer Balance: $XXX.XX"
    - Back button navigation between steps
    - Actions: Cancel, Pay (enabled when amount entered)
    - Animated step transitions using `AnimatedContent`
  - **ViewModel Logic (`CheckoutViewModel`):**
    - `onOpenVendorPayoutDialog()`: Validation (cart must be empty), loads vendors
    - `onVendorPayoutSelectVendor()`: Transitions to step 2
    - `onVendorPayoutBack()`: Returns to step 1
    - Digit/Clear/Backspace handlers for amount input
    - `onVendorPayoutConfirm()`: Permission check with `RequestAction.VENDOR_PAYOUT`
      - GRANTED/SELF_APPROVAL ‚Üí execute directly
      - REQUIRES_APPROVAL ‚Üí show ManagerApprovalDialog
      - DENIED ‚Üí show error message
    - `executeVendorPayout()`: Calls session manager, prints virtual receipt
    - Success feedback: "Payout Recorded: $50.00 to Pepsi"
  - **DI Updates (`CheckoutModule`):**
    - Added `VendorRepository` singleton binding
    - Updated `CheckoutViewModel` with `VendorRepository` dependency
  - **Governance Compliance:**
    - Validation: Cannot pay out more cash than drawer balance
    - Security: Requires Manager approval (unless user is Manager)
    - Reporting: ShiftReport now includes `totalVendorPayouts` in Z-Report
    - Audit trail: Console output with timestamp, employee, manager, vendor, amounts
    - Virtual receipt printed to console with signature lines

- **Age Verification Dialog (P2 #4)**: Restricted Item "Gatekeeper" for age-restricted products
  - **Domain Layer (`features/checkout/domain/model/`):**
    - Updated `Product` model: Changed `ageRestriction` from `String` to `Int?`
    - Added `isAgeRestricted: Boolean` computed property for convenience checks
    - Age values: 21 (Alcohol), 18 (Tobacco), null (unrestricted)
  - **Data Seeding (`core/database/seeder/`):**
    - Added "Craft Beer 6-Pack" (21+ restriction, Alcohol category, $12.99)
    - Added "Cigarettes" (18+ restriction, Tobacco category, $8.50)
    - Synchronized `InitialProducts.kt` and `FakeProductRepository.kt`
  - **UI Component (`features/checkout/presentation/components/dialogs/AgeVerificationDialog.kt`):**
    - Title: "Age Verification Required"
    - Warning icon with orange color
    - Body: "Item: {ProductName} (Minimum Age: {Age})"
    - DOB Input: MM/DD/YYYY format using TenKey component
    - Dynamic "Current Age: XX" display (green if valid, red if underage)
    - Action buttons: Cancel, Confirm (enabled only if age >= limit)
    - Manager Override button for approval workflow
    - Green header per UI_DESIGN_SYSTEM.md
  - **State Management (`CheckoutUiState`):**
    - `AgeVerificationDialogState` data class with:
      - `isVisible`: Controls dialog visibility
      - `pendingProduct`: Product awaiting verification
      - `requiredAge`: Minimum age requirement
      - `dobInput`: Raw DOB digits (MMDDYYYY)
      - `currentAge`: Calculated age from DOB
      - `errorMessage`: Validation errors
      - `isConfirmEnabled`: Confirm button state
  - **ViewModel Logic (`CheckoutViewModel`):**
    - `onDobInput(digit)`: Handles digit input, validates, calculates age
    - `onClearDob()`: Clears DOB input field
    - `onBackspaceDob()`: Removes last DOB digit
    - `onConfirmAgeVerification(dob)`: Verifies age and adds to cart
    - `onCancelAgeVerification()`: Dismisses dialog, clears pending
    - `onManagerOverrideAgeVerification()`: Bypasses age check (for managers)
    - `calculateAge(dob, today)`: Uses `java.time.Period.between()` for accurate age
    - Age-restricted products intercepted in `processScan()` and `onProductSelected()`
  - **Event Wiring (`CheckoutScreen`):**
    - Added 6 new `CheckoutEvent` types for age verification flow
    - Events: AgeVerificationDobInput, AgeVerificationClearDob, AgeVerificationBackspaceDob,
      AgeVerificationConfirm, AgeVerificationCancel, AgeVerificationManagerOverride
    - All events wired to corresponding ViewModel methods
  - **Governance Compliance:**
    - Item CANNOT be added to cart until dialog is confirmed
    - Age calculated correctly using `Clock.System.now()` (handles leap years)
    - DOB validated for valid date format before age calculation
    - Manager Override provides approval workflow for edge cases
  - **Data Layer Fixes:**
    - Updated `CouchbaseProductRepository` (Desktop & Android) for `Int?` ageRestriction type
    - Read: `(map["ageRestriction"] as? Number)?.toInt()`
    - Write: `product.ageRestriction?.let { doc.setInt("ageRestriction", it) }`

- **Device Registration Flow (P2 #2)**: Station Claiming / Out-of-Box Experience (OOBE)
  - **Domain Layer (`features/device/`):**
    - `DeviceInfo` model: stationId, apiKey, branchName, branchId, environment
    - `RegistrationState` enum: UNREGISTERED, PENDING, IN_PROGRESS, REGISTERED, ERROR
    - `QrRegistrationResponse` and `DeviceStatusResponse` API models
    - `DeviceRepository` interface:
      - `isRegistered()`: Check if stationId and apiKey exist
      - `registerDevice(deviceInfo)`: Save registration data locally
      - `clearRegistration()`: Clear for environment change
      - `generatePairingCode()`: Random 8-char code (XXXX-XXXX format)
      - `requestQrCode()` and `checkRegistrationStatus()`: API methods (mock for P2)
    - `FakeDeviceRepository`: In-memory implementation for development
      - `simulateActivation()`: Dev tool to bypass cloud check
  - **Presentation Layer (`features/device/presentation/`):**
    - `RegistrationUiState`: State for pairing code, QR image, registration status
    - `RegistrationEvent`: Events for refresh, simulate, admin settings
    - `RegistrationViewModel`: Manages registration flow and clock updates
    - `RegistrationScreen`: Voyager Screen with admin settings access
    - `RegistrationContent`: 50/50 split layout matching LoginScreen style
      - Header: "Welcome to GroPOS"
      - QR Code placeholder (200x200dp with QrCode2 icon)
      - Pairing Code display (large monospace typography)
      - Instructions: "Go to admin.gropos.com to activate"
      - "Generate New Code" refresh button
      - **Dev Tool**: "Simulate Activation" button (orange, visible in dev mode)
  - **Reusable Component (`core/components/SecretTriggerFooter.kt`):**
    - Extracted from LoginContent for reuse across screens
    - 5-click trigger within 2 seconds opens admin settings
    - Used by LoginScreen and RegistrationScreen
  - **App.kt Navigation Logic:**
    - App Launch ‚Üí Check `deviceRepository.isRegistered()`
    - If `true` ‚Üí Start with `LoginScreen`
    - If `false` ‚Üí Start with `RegistrationScreen`
    - Registration success ‚Üí Navigate to `LoginScreen`
  - **DI Module (`core/di/DeviceModule.kt`):**
    - `DeviceRepository` as singleton (FakeDeviceRepository)
    - `RegistrationViewModel` as factory
    - Integrated into appModule
  - **Governance Compliance:**
    - Hidden Settings accessible from RegistrationScreen (to set Environment before registering)
    - Persistence: Uses FakeDeviceRepository (in-memory for P2, TODO: persist)
    - Dev-only "Simulate Activation" button clearly labeled
    - Registration check on app launch (per DEVICE_REGISTRATION.md flow)

- **Hidden Settings Menu (P2 #1)**: Technician/Admin Dashboard accessible from Login Screen
  - **Secret Trigger (`LoginContent.kt`):**
    - Click copyright text 5 times rapidly (within 2 seconds) to open Admin Settings
    - Per SCREEN_LAYOUTS.md: Hidden Administration Menu Trigger on footer
    - Test tag `secret_admin_trigger` for UI automation
  - **Admin Settings Dialog (`AdminSettingsDialog.kt`):**
    - Tab-based navigation: Device Info, Database, Environment
    - Professional dark header with settings icon
    - Per SCREEN_LAYOUTS.md: Full dialog specification implementation
  - **Device Info Section:**
    - App Version display
    - Device ID (GUID) - unique device identifier
    - IP Address (placeholder for network info)
    - Branch Name and Current Environment
  - **Database Section:**
    - Statistics table showing record counts per collection:
      - Products, Transactions, Categories, Employees, Customers, Held Transactions
    - Last Sync timestamp
    - Refresh button to reload stats
    - **Wipe Database button (Danger Red):**
      - Per Governance: Requires second confirmation dialog
      - Warning icon and destructive action warning text
      - "Yes, Wipe It" / "No, Keep It" confirmation buttons
  - **Environment Section:**
    - Radio button selection: Production / Staging / Development
    - Shows base URL for each environment
    - "CURRENT" badge on active environment
    - **Clear Database and Change Environment button:**
      - Only shown when selected environment differs from current
      - Orange warning style to indicate destructive action
  - **State Management (`SettingsUiState.kt`):**
    - `AdminTab` enum: DEVICE_INFO, DATABASE, ENVIRONMENT
    - `EnvironmentType` enum with display names and base URLs
    - `DatabaseStats` model for collection record counts
    - `SettingsEvent` sealed interface for all dialog actions
  - **ViewModel (`SettingsViewModel.kt`):**
    - Event-driven architecture with `onEvent()` handler
    - Database stats querying (placeholder implementation)
    - Environment selection with validation
    - Wipe confirmation flow with loading state
    - Audit logging to console on wipe action
  - **DI Module (`SettingsModule.kt`):**
    - SettingsViewModel as factory (fresh state per dialog)
    - Integrated into appModule
  - **LoginViewModel Integration:**
    - `showAdminSettings()` / `hideAdminSettings()` methods
    - `showAdminSettings: Boolean` state property
  - **LoginScreen Integration:**
    - Renders AdminSettingsDialog when state.showAdminSettings is true
    - Injects SettingsViewModel via Koin
  - **Governance Compliance:**
    - Wipe Database requires confirmation dialog (double-confirm)
    - Menu only accessible from Login Screen (pre-authentication)
    - Audit trail logged to console for destructive actions

- **Cash Pickup Screen (P1 #4)**: Cash drawer management for safe deposits
  - **Unit Tests (`CashierSessionManagerTest.kt`)**:
    - Session creation and management tests
    - Transaction recording tests (cash sales)
    - Cash pickup validation tests:
      - Fails when no active session
      - Fails when amount is zero or negative
      - Fails when amount exceeds drawer balance (Insufficient Funds)
      - Succeeds and decreases drawer balance correctly
      - Multiple pickups accumulate correctly
      - Pickup exactly equal to balance succeeds
  - **Domain Layer (`features/cashier/domain/`):**
    - Updated `CashierSession` model with cash pickup tracking:
      - `totalCashPickups`: Running total of cash pickups during session
      - `cashPickupCount`: Number of pickups performed
    - Updated `CashierSessionManager`:
      - `cashPickup(amount, managerId)`: Records pickup, decreases drawer balance
      - `getCurrentDrawerBalance()`: Returns current expected cash in drawer
      - Validation: Cannot pickup more than current balance
      - Audit logging to console with manager approval info
    - Updated `ShiftReport` model with cash pickup summary in Z-Report
  - **UI Component (`CashPickupDialog.kt`):**
    - Modal dialog per DIALOGS.md pattern
    - Green header with "Cash Pickup" title
    - Display of current drawer balance
    - Amount input with TenKey (cents-based entry)
    - Input validation with error messages
    - Cancel and Pickup action buttons
    - Test tags for UI automation
  - **State Management:**
    - `CashPickupDialogState` in `CheckoutUiState`:
      - `isVisible`, `inputValue`, `currentBalance`, `errorMessage`
    - `CheckoutEvent` extensions for cash pickup flow:
      - `OpenCashPickupDialog`, `DismissCashPickupDialog`
      - `CashPickupDigitPress`, `CashPickupClear`, `CashPickupBackspace`
      - `CashPickupConfirm`, `DismissCashPickupFeedback`
  - **ViewModel Logic (`CheckoutViewModel`):**
    - `onOpenCashPickupDialog()`: Opens dialog with current balance
    - Permission check via `PermissionManager.checkPermission(RequestAction.CASH_PICKUP)`
    - Manager approval flow for cashiers (managers can self-approve)
    - `executeCashPickup()`: Calls `CashierSessionManager.cashPickup()`
    - Virtual receipt printing to console
    - Success feedback via Snackbar
  - **UI Integration:**
    - "Pickup" button added to `FunctionsGrid` (orange/warning style)
    - Cash Pickup in `FunctionsPanel` Payments tab (already existed)
    - Dialog wired in `CheckoutContent` with all event handlers
    - Feedback Snackbar for successful pickups
  - **Governance:**
    - Validation: Cannot pickup more than drawer balance
    - Validation: Cart must be empty before pickup
    - Security: Always requires Manager approval (unless user is Manager)
    - Audit trail: Console output with timestamp, employee, manager, amounts

- **Payment Terminal Integration (P1 #1)**: Hardware abstraction for card payments
  - **Domain Layer (`features/payment/domain/terminal/`):**
    - `PaymentTerminal`: Interface for payment terminal hardware abstraction
      - `processPayment(amount)`: Suspending function for card payment processing
      - `cancelTransaction()`: Cancels pending terminal operation
    - `PaymentResult`: Sealed class representing terminal transaction outcomes
      - `Approved`: Success with transactionId, cardType, lastFour, authCode
      - `Declined`: Issuer decline with reason
      - `Error`: Technical failure (timeout, disconnection)
      - `Cancelled`: User cancelled via POS
  - **Data Layer (`features/payment/data/`):**
    - `SimulatedPaymentTerminal`: Development implementation of `PaymentTerminal`
      - Simulates 2-second "Insert Card" delay
      - Returns Approved with mock VISA **** 1234, Auth: AUTH001
      - Supports cancellation during processing
      - Thread-safe with Mutex
  - **DI Integration (`PaymentModule`):**
    - Binds `PaymentTerminal` to `SimulatedPaymentTerminal` (singleton)
    - Production: Swap to real implementation (PAX/Sunmi/JavaPOS)
  - **UI Components (`PaymentTerminalDialog.kt`):**
    - Modal overlay shown during card payment processing
    - Animated card icon with pulsing effect
    - "Please Insert Card on Terminal" instruction text
    - Amount display
    - Spinner/progress indicator
    - Cancel button to abort transaction
    - Test tags for UI testing
  - **ViewModel Integration (`PaymentViewModel`):**
    - `onCreditPayment()`: Initiates credit card payment via terminal
    - `onDebitPayment()`: Initiates debit card payment via terminal
    - `onEbtSnapPayment()`: Initiates EBT SNAP payment via terminal
    - `onEbtCashPayment()`: Initiates EBT Cash payment via terminal
    - `onCancelTerminalTransaction()`: Cancels pending terminal operation
    - Non-blocking: Uses coroutines, UI never freezes
    - Result handling: Approved adds payment, Declined/Error shows toast
  - **State Management (`PaymentUiState`):**
    - `showTerminalDialog`: Controls terminal dialog visibility
    - `terminalDialogAmount`: Formatted amount for dialog display
  - **Governance:**
    - ViewModel is terminal-agnostic (doesn't know if simulated or real)
    - Hardware abstraction enables testing without physical terminal
    - Ready for PAX, Sunmi, JavaPOS implementations

- **Hold & Recall Transactions (P1 #2)**: Suspend and resume transactions
  - **Domain Models (`features/transaction/domain/model/HeldTransaction.kt`):**
    - `HeldTransaction`: Represents a suspended transaction with all cart data
    - `HeldTransactionItem`: Individual item data for restoration
    - Stores complete cart state: items, quantities, prices, discounts
  - **Repository Extension (`TransactionRepository`):**
    - `holdTransaction(heldTransaction)`: Saves transaction to HeldTransaction collection
    - `getHeldTransactions()`: Returns all held transactions (ordered by time)
    - `getHeldTransactionById(id)`: Retrieves specific held transaction
    - `deleteHeldTransaction(id)`: Removes held transaction after recall
  - **Database Implementation (Desktop & Android):**
    - New collection: `HeldTransaction` in `local` scope (per DATABASE_SCHEMA.md)
    - Index on `heldDateTime` for ordering queries
    - Full item serialization and restoration
  - **UI Components:**
    - `HoldTransactionDialog`: Optional name/note for held transaction
      - Displays current cart total and item count
      - "Recall Name" input field (e.g., "Guy in blue shirt")
      - Hold and Cancel buttons
    - `RecallTransactionsDialog`: List of held transactions
      - Shows hold name, time, item count, and total
      - Restore button to load items back to cart
      - Delete button to remove held transaction
      - Empty state when no held transactions
  - **ViewModel Integration (`CheckoutViewModel`):**
    - `onOpenHoldDialog()`: Opens hold dialog (validation: cart not empty)
    - `onConfirmHold(holdName)`: Creates HeldTransaction, clears cart
    - `onOpenRecallDialog()`: Loads and displays held transactions
    - `onRestoreTransaction(id)`: Restores items to cart, deletes held record
    - `onDeleteHeldTransaction(id)`: Removes held transaction without restoring
    - Feedback toasts: "Transaction Held" / "Transaction Restored"
  - **UI Wiring:**
    - Added "Hold" button to FunctionsGrid (alongside Lookup, Recall, Void)
    - "Recall" button now opens RecallTransactionsDialog (not TransactionHistory)
    - New events: OpenHoldDialog, ConfirmHold, OpenRecallDialog, RestoreTransaction, etc.
  - **Governance:**
    - Cannot hold empty cart (validation with error message)
    - Cannot restore to non-empty cart (clear first)
    - Items restored with original quantities, prices, and discounts
    - Audit log output on hold and recall actions
  - **Testing Infrastructure:**
    - `FakeTransactionRepository` for unit testing hold/recall flows
    - Updated `CheckoutViewModelTest` with transactionRepository injection

- **Complete Logout Flow (P1 #5)**: Advanced logout with three options
  - **LogoutDialog (`LogoutDialog.kt`):**
    - Option 1: Lock Station (Blue) - Keeps session active, requires PIN to re-enter
    - Option 2: Release Till (Orange) - Simple logout, frees drawer for another user
    - Option 3: End of Shift (Red) - Full close-out with Z-Report
    - Disabled options when cart is not empty (safety check)
  - **CashierSessionManager (`CashierSessionManager.kt`):**
    - Tracks active session from login to logout
    - `releaseTill()` - Quick logout that releases the till
    - `endShift()` - Full shift close with ShiftReport generation
    - Session metrics tracking (transaction count, sales totals)
  - **ShiftReport (`ShiftReport.kt`):**
    - Z-Report model with transaction summary, sales breakdown, payment methods
    - Cash drawer reconciliation (opening float, cash in/out, expected vs actual)
    - `formatForPrint()` for console/receipt output
  - **UI Integration:**
    - "Sign Out" button in FunctionsGrid triggers LogoutDialog
    - Lock Station calls `InactivityManager.manualLock()`
    - Release Till and End Shift navigate back to LoginScreen
    - Logout feedback via Snackbar

- **Void Transaction (P1 #3)**: Full transaction void functionality
  - **UI Component (`VoidConfirmationDialog.kt`):**
    - Confirmation dialog with warning icon
    - "No, Keep It" (cancel) and "Yes, Void It" (danger/red) buttons
    - Prevents accidental transaction voids
  - **State Management:**
    - Added `showVoidConfirmationDialog` to `CheckoutUiState`
    - Added `VoidTransactionRequest`, `ConfirmVoidTransaction`, `CancelVoidTransaction` events
  - **Logic (`CheckoutViewModel`):**
    - `onVoidTransactionRequest()`: Checks permission before showing dialog
    - Permission check: GRANTED/SELF_APPROVAL -> show confirmation
    - REQUIRES_APPROVAL -> show manager approval first
    - DENIED -> show error message
    - Audit logging to console on void completion
    - State reset: clears modification mode if active
  - **Functions Grid:**
    - Added "Void" button (Danger style) to FunctionsGrid
    - Quick access alongside Lookup, Recall, Functions buttons
  - **Governance:**
    - Double confirmation flow (permission check + dialog)
    - Audit trail logged to console
    - Cart cleared only after confirmation

- **Returns Processing (P0 #5)**: Return Item Screen and refund logic
  - **Domain Models (`features/returns/domain/model/ReturnModels.kt`):**
    - `ReturnReason` enum: DEFECTIVE, WRONG_ITEM, CHANGED_MIND, QUALITY, OTHER
    - `ReturnableItem`: Original transaction items with remaining quantity
    - `ReturnItem`: Items selected for return with quantity and reason
    - `ReturnCart`: Collection of return items with refund totals
  - **Domain Service (`features/returns/domain/service/ReturnService.kt`):**
    - `getReturnableItems(transactionId)`: Fetches returnable items from transaction
    - `validateReturnQuantity()`: Ensures return qty <= remaining qty
    - `createReturnItem()` and `createReturnCart()`: Factory methods
    - `validateReturnCart()`: Cart validation before processing
  - **Presentation (`features/returns/presentation/`):**
    - `ReturnUiState`: State for returnable items, return cart, dialogs
    - `ReturnViewModel`: Manages return flow, quantity dialog, manager approval
    - `ReturnScreen`: Voyager Screen with transactionId parameter
    - `ReturnContent`: 70/30 split layout per SCREEN_LAYOUTS.md
      - Left panel: Returnable items grid with "Add to Return" buttons
      - Right panel: Return cart, refund totals, "Process Return" button
    - Quantity dialog with TenKey for selecting return quantity
    - Simple manager approval dialog (P0 stub)
  - **Navigation Wiring:**
    - Added "Return Items" button to TransactionHistoryScreen detail view
    - Button navigates to ReturnScreen with selected transaction ID
  - **DI (`core/di/ReturnsModule.kt`):**
    - ReturnService as singleton
    - ReturnViewModel as factory
- **Employee List + Till Assignment (P0 #4)**: Login V2 with state machine flow
  - **Domain Models (`features/cashier/domain/model/`):**
    - `Till`: Cash drawer model with availability tracking
    - `CashierSession`: Session tracking with shift metrics
    - `Employee`: Enhanced employee model for login grid
  - **Repositories (`features/cashier/domain/repository/` & `data/`):**
    - `TillRepository` interface with `getTills()`, `assignTill()`, `releaseTill()`
    - `EmployeeRepository` interface with `getEmployees()`, `verifyPin()`, `getApprovers()`
    - `FakeTillRepository`: In-memory till management
    - `FakeEmployeeRepository`: Test employees matching FakeAuthRepository
  - **Refactored Login Flow (per CASHIER_OPERATIONS.md):**
    - `LoginUiState`: Now a data class with `LoginStage` enum (LOADING, EMPLOYEE_SELECT, PIN_ENTRY, TILL_ASSIGNMENT, SUCCESS)
    - `LoginViewModel`: State machine with employee selection, PIN verification, till assignment
    - `LoginContent`: Multi-stage UI with employee grid, PIN entry, and till dialog
    - `LoginScreen`: Navigation on SUCCESS stage
  - **UI Components:**
    - `TillSelectionDialog`: Per DIALOGS.md spec with table layout
    - Employee cards with avatar initials, name, and role
    - PIN dot display and TenKey integration
    - Back button navigation between stages
  - **DI Updates (`core/di/AuthModule.kt`):**
    - Added `EmployeeRepository` and `TillRepository` bindings
    - Updated `LoginViewModel` to use new repositories
  - **Tests (`LoginViewModelTest.kt`):**
    - Full state machine test coverage
    - Tests for employee selection, PIN entry, till assignment
    - Tests for error handling and back navigation
- **Manager Approval Flow (P0 #2)**: RBAC infrastructure for sensitive actions
  - Created `core/security/PermissionModels.kt` with:
    - `PermissionCheckResult` enum: GRANTED, REQUIRES_APPROVAL, SELF_APPROVAL_ALLOWED, DENIED
    - `RequestAction` enum: Maps actions to permission base strings per ROLES_AND_PERMISSIONS.md
    - `ApprovalResult` sealed class: Approved, Denied, Error
    - `ApprovalAuditEntry` data class for audit logging
    - `ApprovalState` sealed class: Flow state machine (Idle -> SelectManager -> EnterPin -> Approved/Denied)
    - `ManagerInfo` data class for manager list display
  - Created `core/security/PermissionManager` singleton:
    - `checkPermission(user, action)`: Checks direct permission, then .Request, then .Self Approval
    - `checkRoleDefaults()`: Role-based fallbacks for Admin/Manager/Supervisor/Cashier
    - `canApproveForOthers()`: Check if user can approve requests
    - `getRoleLevel()` and `hasMinimumRole()`: Role hierarchy utilities
  - Created `core/security/ManagerApprovalService`:
    - `getApprovers(action, currentUser)`: Returns managers who can approve, excludes self if no self-approval
    - `validateApproval()`: Validates manager PIN and logs to audit trail
    - `generateApprovalCode()`: Format APR-YYYYMMDD-XXXX
    - Console audit log output for verification (no PIN in logs per governance)
    - Walking skeleton: Manager "9999" uses PIN "1234", Manager "9998" uses PIN "5678"
  - Created `core/components/dialogs/ManagerApprovalDialog.kt`:
    - Two-step flow per DIALOGS.md: Select Manager -> Enter PIN
    - Green header (#04571B) per UI_DESIGN_SYSTEM.md
    - Manager list with avatar, name, job title
    - TenKey integration for PIN entry
    - PIN dot display (4-6 digits)
    - Error message display for invalid PIN
    - Back/Cancel/Approve buttons
  - Updated `AuthUser` model with:
    - `permissions: List<String>`: Permission strings per ROLES_AND_PERMISSIONS.md
    - `isManager: Boolean`: Can approve requests for others
    - `jobTitle: String?`: Display in approval dialog
    - `imageUrl: String?`: Avatar URL
  - Updated `FakeAuthRepository` with permission-aware users:
    - Admin: Full direct permissions
    - Manager (ID 9999): .Self Approval permissions
    - Supervisor (ID 9998): Mixed .Request and .Self Approval
    - Cashier: .Request permissions only
  - Updated `CheckoutViewModel`:
    - `onVoidSelectedLineItem()` now checks permissions before voiding
    - Shows `ManagerApprovalDialog` if REQUIRES_APPROVAL
    - `onSubmitManagerApproval()`: Validates PIN and executes pending action
    - `executeApprovedAction()`: Executes voiding after approval
  - Updated `CheckoutUiState` with `ManagerApprovalDialogState`
  - Updated `CheckoutScreen` with manager approval events
  - Updated `CheckoutContent` to render `ManagerApprovalDialog`
  - Updated `CheckoutModule` with `ManagerApprovalService` singleton
- **Lock Screen & Inactivity Timer (P0 #1)**: Security feature for automatic session lock
  - Created `LockScreen.kt` (Voyager Screen) with dark gradient theme per SCREEN_LAYOUTS.md
    - Left panel: Station name, large real-time clock, date, lock status, version footer
    - Right panel: Employee info card, PIN entry display, TenKey pad, Verify/Sign Out buttons
  - Created `LockContent.kt` composable with visual specs per CASHIER_OPERATIONS.md
    - Lock status indicator (LOCKED text with lock icon)
    - Lock type display: "Session timed out" / "Manually locked" / "Locked by manager"
    - PIN dot display (8 dots max, filled based on input)
    - Error message display for invalid PIN
  - Created `LockViewModel.kt` with session logic
    - Real-time clock using `kotlinx-datetime` (updates every second)
    - PIN input management (max 8 digits)
    - Walking skeleton: Accepts "1234" as valid PIN (TODO: API verification)
    - `UnlockResult` and `SignOutResult` sealed interfaces for navigation
  - Created `LockUiState.kt` data class with state properties
    - `LockType` enum: AutoLocked, Locked, ManagerLocked
    - Station name, employee info, PIN input, verification status
  - Created `InactivityManager` singleton in `core/session/`
    - Tracks last user interaction time
    - Configurable timeout (default: 5 minutes per CASHIER_OPERATIONS.md)
    - Emits `LockEvent` via SharedFlow when timeout triggers
    - `recordActivity()` called on any user interaction to reset timer
    - `manualLock()` for F4 key shortcut
    - Screen exemption list (LockScreen, LoginScreen, CustomerDisplay)
  - Updated `App.kt` with inactivity detection
    - Box wrapper with `pointerInput` to detect taps/clicks
    - `onPreviewKeyEvent` to detect keyboard input
    - F4 key triggers manual lock per CASHIER_OPERATIONS.md
    - Listens to `InactivityManager.lockEvent` and navigates to LockScreen
  - Updated `LoginScreen.kt` to start InactivityManager after successful login
  - Updated `AuthModule.kt` to provide `LockViewModel`
  - Lock types map to `DeviceEventType` per spec (AutoLocked, Locked, ManagerLocked)
- **Checkout Modification Mode**: Line item modification panel (per SCREEN_LAYOUTS.md)
  - Clicking a line item enters modification mode (right panel transforms)
  - Selected item highlighted with green border and background
  - Mode buttons: QUANTITY (change qty 1-99), DISCOUNT (%), PRICE (override)
  - Weighted items start in DISCOUNT mode (quantity disabled)
  - TenKey with mode-specific input display (prefix/suffix based on mode)
  - REMOVE ITEM button to void selected line (marks as isRemoved)
  - BACK button exits modification mode
  - Updated `CheckoutUiState` with `selectedItemId`, `selectedItem`, `modificationTenKeyMode`, `modificationInputValue`
  - Added `isModificationMode` computed property for panel swap logic
  - Created `ModificationPanel` composable with full modification UI
  - Created `ModeButton` component for mode selection
  - Created `SelectedItemUiModel` for modification panel display
  - Added `ModificationTenKeyMode` enum (QUANTITY, DISCOUNT, PRICE)
  - Added 8 new modification events to `CheckoutEvent` sealed interface
  - Added modification handlers to `CheckoutViewModel`
  - Integrated `CartRepository.updateQuantity()` for quantity changes
  - Integrated `CartRepository.voidItem()` for remove item action
- **Transaction History Screen (Recall)**: View and browse completed transactions
  - Created `TransactionHistoryScreen.kt` (Voyager Screen) for transaction history
    - Per FUNCTIONS_MENU.md: Return/Invoice functionality
    - Per SCREEN_LAYOUTS.md: Order Report Screen layout
  - Created `TransactionHistoryContent.kt` with 40/60 split layout
    - Left pane: Scrollable transaction list (ID, time, total, payment method)
    - Right pane: Detailed transaction view (items, totals, payments)
    - Empty state with "No Recent Transactions" message
  - Created `TransactionHistoryViewModel` with data loading
    - Loads recent transactions via `TransactionRepository.getRecent()`
    - Auto-selects first transaction on load
    - Date formatting (ISO-8601 to "Jan 01, 2:30 PM")
  - Created `TransactionHistoryUiState` with UI models
    - `TransactionListItemUiModel` for list display
    - `TransactionDetailUiModel` for detail view
  - Created `TransactionModule` for Koin DI
  - Wired "Recall" button in `FunctionsGrid` to navigate to history screen
  - Added `NavigateToRecall` event to `CheckoutEvent` sealed interface
- **Transaction Persistence**: Completed transactions are now saved to CouchbaseLite database
  - Created `Transaction`, `TransactionItem`, `TransactionPayment` domain models (per DATABASE_SCHEMA.md)
    - Transaction document structure aligns with LocalTransaction collection schema
    - Supports all monetary fields with BigDecimal precision
    - Includes items array and payments array per schema
  - Created `Cart.toTransaction()` mapper function
    - Converts Cart and AppliedPayments to finalized Transaction
    - Generates unique UUID for transaction ID and guid
    - Captures timestamps in ISO-8601 format
  - Created `TransactionRepository` interface with `saveTransaction()`, `getById()`, `getRecent()`, `getPending()` methods
  - Created `CouchbaseTransactionRepository` for Desktop and Android
    - Collection: `LocalTransaction` in `local` scope (per DATABASE_SCHEMA.md)
    - Creates index on `completedDateTime` for history queries
    - Full document serialization with items and payments arrays
    - Error handling: Returns Result.failure instead of crashing
  - Updated `PaymentViewModel` to save transaction on payment completion
    - Injects `TransactionRepository` dependency
    - Converts cart to transaction when balance reaches zero
    - Only clears cart after successful save
  - Implemented virtual receipt printer (console output)
    - Simulates physical receipt printer output
    - Shows all items, quantities, prices, taxes, CRV
    - Shows payment methods and change
    - ASCII-formatted receipt for easy debugging
  - Updated `DatabaseModule` (Desktop/Android) to provide `CouchbaseTransactionRepository`
  - Updated `PaymentModule` to inject `TransactionRepository` into `PaymentViewModel`
- **Offline-First Persistence (CouchbaseLite)**: Replaced in-memory fakes with persistent database
  - Created `expect/actual DatabaseProvider` for multiplatform database initialization
    - Desktop: Uses CouchbaseLite Java SDK, stores in user.dir
    - Android: Uses CouchbaseLite Android SDK, stores in context.filesDir
  - Created `CouchbaseProductRepository` implementing `ProductRepository`
    - Query by barcode: Uses ArrayExpression on `itemNumbers` array (per DATABASE_SCHEMA.md)
    - Query by category: Uses Expression.property with ordering
    - Search products: LIKE operator on productName
    - Full document mapping to `Product` entity with taxes, CRV, itemNumbers
  - Created `DebugDataSeeder` for first-launch data population
    - Checks if Product collection is empty
    - Seeds all 10 test products (Milk, Apple, Cola, Chips, etc.)
    - Called immediately after Koin initialization
  - Created `InitialProducts` object with shared seed data
  - Created platform-specific `DatabaseModule` for Koin DI
    - Provides DatabaseProvider as singleton
    - Provides CouchbaseProductRepository bound to ProductRepository interface
    - Provides DebugDataSeeder
  - Updated `Main.kt` (Desktop) to initialize database module and seed on startup
  - Updated `MainActivity.kt` (Android) to initialize database module and seed on startup
  - Removed `FakeProductRepository` from production DI (still available for tests)
- **Advanced Calculation Engine**: Production-grade tax, CRV, and discount calculations
  - Created `TaxCalculator` service (per TAX_CALCULATIONS.md, SERVICES.md)
    - Tax Consistency Rule: Tax per unit rounded BEFORE multiplying by quantity
    - SNAP-eligible items are tax-exempt (returns zero tax)
    - CRV is ALWAYS included in taxable amount (California law)
  - Created `CRVCalculator` service (per DEPOSITS_FEES.md, SERVICES.md)
    - California Redemption Value calculation per product
    - Supports $0.05 (<24oz) and $0.10 (>=24oz) CRV rates
    - CRV is tracked separately but included in grand total
  - Created `DiscountCalculator` service (per SERVICES.md)
    - Price hierarchy: Prompted ‚Üí Customer ‚Üí Sale ‚Üí Bulk ‚Üí Retail
    - Percentage and fixed amount discount support
    - Floor price enforcement with manager override option
    - Savings calculation per unit and total
  - Updated `FakeProductRepository` with comprehensive test products:
    - Cola 2-Liter: Taxable (9.5%) with CRV ($0.10)
    - Cola Can 12oz: Taxable (9.5%) with CRV ($0.05)
    - Bottled Water: SNAP-eligible (no tax) with CRV ($0.05)
    - Potato Chips: SNAP-eligible (no tax), no CRV
    - Hot Dog: Taxable (9.5%), not SNAP-eligible, no CRV
  - Added `snapEligibleTotal` property to `Cart` for payment screen SNAP tracking
  - Registered all calculators as singletons in Koin `checkoutModule`
- **Payment Screen**: Full payment flow with split tender support (per SCREEN_LAYOUTS.md)
  - Created `PayScreen.kt` and `PayContent.kt` with horizontal split layout
  - Left panel: Transaction summary, SNAP eligible total, payments applied, remaining amount
  - Right panel: Payment method tabs (Cash, Charge, EBT, Other), TenKey
  - Created `PaymentViewModel` observing shared `CartRepository` singleton
  - SNAP eligibility displayed separately from non-SNAP totals (per PAYMENT_PROCESSING.md)
  - Cash payments: Quick amounts ($1-$100), exact change, entered amount
  - Split tender: Multiple payments tracked and displayed
  - Change dialog shown when cash overpaid
  - Card/EBT payments show placeholder message (terminal not connected)
  - Navigation from Checkout "Pay" button to Payment screen
  - Created `PaymentModule.kt` for Koin DI
  - Domain models: `PaymentType`, `PaymentStatus`, `PaymentResponse`, `AppliedPayment`
- **Product Lookup Dialog**: Full product search/browse dialog (per SCREEN_LAYOUTS.md)
  - Created `ProductLookupDialog.kt` with categories sidebar and products grid
  - Extended `ProductRepository` with `searchProducts(query)` and `getCategories()` methods
  - Updated `FakeProductRepository` to support combined search (name + barcode)
  - Added lookup state management to `CheckoutUiState` and `CheckoutViewModel`
  - Integrated with checkout screen via "Lookup" button in Functions Grid
  - Auto-focus search field on dialog open
  - SNAP eligibility badge on product cards
  - Category filtering and "All Products" view
  - Product selection adds item to cart and closes dialog
- **Multi-Window State Synchronization**: Implemented true cross-window cart state sharing
  - Created `CartRepository` interface in domain layer (Single Source of Truth pattern)
  - Created `CartRepositoryImpl` as singleton for shared cart state across windows
  - Created `CustomerDisplayViewModel` to observe shared cart state
  - Refactored `ScanItemUseCase` to use CartRepository instead of internal state
  - Refactored `CheckoutViewModel` to observe CartRepository (not own state)
  - Updated Koin module: `CartRepository` as `single {}` for true singleton
  - Updated `CustomerDisplayScreen` with Voyager Screen wrapper
  - Removed placeholder `SharedAppState` object in favor of proper DI
- UI/UX Design System: `Color.kt` with GroPOS color palette per UI_DESIGN_SYSTEM.md
- UI/UX Design System: `Typography.kt` with Archivo-based typography scale
- UI/UX Design System: `Spacing.kt` with GroPOSSpacing and GroPOSRadius values
- Core components: `Buttons.kt` with SuccessButton, PrimaryButton, DangerButton, WarningButton, OutlineButton, BackButton
- Core components: `Containers.kt` with LeftBlock, RightBlock, WhiteBox, GreenBox, CardBox
- Core components: `TenKey.kt` numeric keypad component with TenKeyMode states
- Core components: `FormFields.kt` with SearchField, QuantityField, PasswordField, BarcodeInputField
- Core components: `FunctionsPanel.kt` with FunctionsGrid and tabbed FunctionsPanel
- Customer Display: `CustomerDisplayScreen.kt` for secondary monitor (per SCREEN_LAYOUTS.md)
- Multi-window support: `Main.kt` updated to detect multiple monitors and launch Customer Display
- Dev Mode: `DEV_FORCE_CUSTOMER_DISPLAY` flag to test dual-window on single monitor
- `SharedAppState` object for cross-window state sharing (placeholder for DI integration)
- Initial Kotlin Multiplatform project scaffolding
- Gradle version catalog (`libs.versions.toml`) with all core dependencies
- Root `build.gradle.kts` and `settings.gradle.kts` configuration
- Module structure: `shared/`, `desktopApp/`, `androidApp/`
- Shared module configured for commonMain, desktopMain, androidMain source sets
- CouchbaseLite database dependency configured for offline-first architecture
- ProGuard rules for Android release builds
- Comprehensive `.gitignore` for KMP projects
- Auth feature domain layer: `AuthUser`, `UserRole`, `AuthError` models
- Auth feature domain layer: `AuthRepository` interface
- Auth feature domain layer: `ValidateLoginUseCase` with PIN validation (4-digit rule)
- Auth feature data layer: `FakeAuthRepository` with simulated 500ms network delay
- Unit tests for `ValidateLoginUseCase` (7 test cases, TDD approach)
- `gradle.properties` with AndroidX and KMP configuration
- Auth feature presentation layer: `LoginUiState` sealed interface (Idle, Loading, Success, Error)
- Auth feature presentation layer: `LoginViewModel` using Voyager ScreenModel
- Auth feature presentation layer: `LoginScreen` with Voyager navigation
- Auth feature presentation layer: `LoginContent` composable with hoisted state
- Auth feature presentation layer: Preview functions for all UI states
- Koin dependency injection: `AuthModule` providing repository, use case, and viewmodel
- Koin dependency injection: `AppModule` aggregating all feature modules
- Integration tests for `LoginViewModel` (6 test cases)
- Checkout feature domain models: `Product`, `CartItem`, `Cart` with BigDecimal precision
- Checkout feature domain model: `ItemNumber`, `ProductTax`, `ProductSale` supporting types
- Checkout feature domain model: `Cart.addProduct()` with quantity increment by branchProductId
- Checkout feature hardware abstraction: `ScannerRepository` interface with `Flow<String>`
- Checkout feature data interface: `ProductRepository` with `getByBarcode()` method (per DATABASE_SCHEMA.md)
- Checkout feature business logic: `ScanItemUseCase` reactive scanning with cart management
- Checkout feature data layer: `FakeProductRepository` with schema-compliant sample data
- Checkout feature data layer: `FakeScannerRepository` with `emitScan()` for testing
- Unit tests for `ScanItemUseCase` (12 test cases including schema compliance tests)
- Core utility: `CurrencyFormatter` interface with `UsdCurrencyFormatter` implementation
- Checkout feature presentation layer: `CheckoutUiState` with `CheckoutItemUiModel`, `CheckoutTotalsUiModel`
- Checkout feature presentation layer: `CheckoutViewModel` with reactive scanner flow collection
- Checkout feature presentation layer: `CheckoutScreen` (Voyager) with standard POS layout
- Checkout feature presentation layer: `CheckoutContent` composable with LazyColumn and totals panel
- Checkout feature UI: SNAP eligibility badge displayed for `isSnapEligible` items
- Checkout feature UI: Scan feedback snackbar for ProductAdded/NotFound events
- Checkout feature UI: Empty cart state with placeholder
- Checkout feature UI: Preview functions for all screen states (5 previews)
- Koin dependency injection: `CheckoutModule` providing all checkout feature dependencies
- Unit tests for `CheckoutViewModel` (14 test cases)
- Core theme: `GroPOSTheme` Material3 theme with professional POS color palette
- Navigation: Root `App.kt` with Voyager Navigator and GroPOSTheme wrapper
- Navigation: `LoginScreen` ‚Üí `CheckoutScreen` transition on successful login
- Navigation: TopAppBar with logout button on `CheckoutScreen`
- Navigation: `CheckoutEvent.Logout` event for logout action
- Desktop entry point: `Main.kt` with Koin initialization and 1280x800 window
- Android entry point: `MainActivity.kt` with Koin initialization and edge-to-edge display
- Android manifest with network, camera, and Bluetooth permissions
- Android resources: strings.xml, themes.xml for app configuration

### Changed
- **BREAKING**: `CartItem.taxPerUnit` calculation now includes CRV in taxable amount (per TAX_CALCULATIONS.md)
  - Previous: `taxableAmount = effectivePrice - discountAmountPerUnit`
  - New: `taxableAmount = (effectivePrice - discounts) + CRV`
  - SNAP-eligible items now return $0.00 tax (tax exemption rule)
- **UI/UX Overhaul**: Refactored entire UI layer to match new UI/UX Source of Truth (docs/development-plan/ui-ux/)
- Refactored `GroPOSTheme.kt` to use GroPOS color palette from UI_DESIGN_SYSTEM.md
  - Primary: PrimaryGreen (#04571B) for success actions
  - Secondary: PrimaryBlue (#2073BE) for alternative actions
  - Error: DangerRed (#FA1B1B) for danger states
  - Backgrounds: LightGray1, LightGray2 for panel sections
- Refactored `CheckoutContent.kt` with 70/30 split layout per SCREEN_LAYOUTS.md
  - LEFT (70%): Order list with info bar and barcode input
  - RIGHT (30%): Totals card, Ten-Key pad, Functions Grid, Pay button
  - Added Order List Item component with 10/10/60/5/15 column weights
  - Moved logout button to left panel header
- Refactored `LoginContent.kt` with 50/50 split layout per SCREEN_LAYOUTS.md
  - LEFT: Branding section with station name, logo, time display
  - RIGHT: Authentication with PIN dot display, Ten-Key pad, Sign In button
- Replaced generic Material3 buttons with custom GroPOS button components
- Renamed application from "GrowPOS" to "GroPOS" across all documentation files (39 occurrences in 8 files)
- Modernized "Food Stamp" terminology to "SNAP" across entire codebase
  - Documentation: Updated DATABASE_SCHEMA.md, ARCHITECTURE_BLUEPRINT.md, TEST_SCENARIOS.md, ANDROID_HARDWARE_GUIDE.md
  - Code: Renamed `isFoodStampEligible` to `isSnapEligible` in Product, CartItem models
  - Hardware: Renamed `processEbtFoodStamp()` to `processEbtSnap()`, `EBT_FOODSTAMP` to `EBT_SNAP`

### Refactored
- **BREAKING**: Refactored `Product` model to align with DATABASE_SCHEMA.md
  - Changed `id` to `branchProductId` (Int)
  - Changed `name` to `productName`
  - Changed `price` to `retailPrice`
  - Changed `sku` to `itemNumbers: List<ItemNumber>` (supports multiple barcodes)
  - Added schema-required fields: category, department, taxes, currentSale, etc.
- **BREAKING**: Refactored `CartItem` to align with TransactionItem schema
  - Changed `quantity` to `quantityUsed`
  - Added `priceUsed`, `taxPerUnit`, `taxTotal`, `crvRatePerUnit` fields
  - Added computed properties matching schema: subTotal, savingsTotal, lineTotal
- **BREAKING**: Refactored `ProductRepository` interface
  - Renamed `findBySku()` to `getByBarcode()` per schema specification
  - Added `getByCategory(categoryId: Int)` method
  - Changed return types to nullable (null instead of Result.failure)
- Updated `FakeProductRepository` to use schema example data (Milk: branchProductId=12345)